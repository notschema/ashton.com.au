---
/**
 * Search Component - Pagefind powered search modal
 * Opens with Cmd/Ctrl+K or click on search button
 */
---

<!-- Search Modal Backdrop -->
<div
  id="search-backdrop"
  class="fixed inset-0 z-50 hidden bg-background/80 backdrop-blur-sm"
  data-pagefind-ignore
>
  <!-- Search Modal -->
  <div
    class="fixed left-1/2 top-1/4 z-50 w-full max-w-2xl -translate-x-1/2 rounded-lg border border-border bg-background p-4 shadow-2xl"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <span class="text-sm text-muted-foreground font-mono">search</span>
      <button
        id="search-close"
        class="text-muted-foreground hover:text-foreground transition-colors"
        aria-label="Close search"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Pagefind Search Container -->
    <div id="pagefind-search"></div>
  </div>
</div>

<!-- Pagefind Styles -->
<style is:global>
  /* Override Pagefind default styles to match site theme */
  :root {
    --pagefind-ui-scale: 1;
    --pagefind-ui-primary: var(--primary);
    --pagefind-ui-text: var(--foreground);
    --pagefind-ui-background: var(--background);
    --pagefind-ui-border: var(--border);
    --pagefind-ui-tag: var(--muted);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0.5rem;
    --pagefind-ui-image-border-radius: 0.5rem;
    --pagefind-ui-image-box-ratio: 3 / 2;
    --pagefind-ui-font: inherit;
  }

  .pagefind-ui__search-input {
    background: var(--muted) !important;
    color: var(--foreground) !important;
    border: 1px solid var(--border) !important;
  }

  .pagefind-ui__search-input::placeholder {
    color: var(--muted-foreground) !important;
  }

  .pagefind-ui__result {
    border-bottom: 1px solid var(--border) !important;
    padding: 1rem 0 !important;
  }

  .pagefind-ui__result-link {
    color: var(--foreground) !important;
  }

  .pagefind-ui__result-link:hover {
    color: var(--primary) !important;
  }

  .pagefind-ui__result-excerpt {
    color: var(--muted-foreground) !important;
  }

  .pagefind-ui__message {
    color: var(--muted-foreground) !important;
  }
</style>

<!-- Search Script -->
<script>
  // Import Pagefind UI
  async function initPagefind() {
    // @ts-ignore
    const { PagefindUI } = await import("@pagefind/default-ui");

    new PagefindUI({
      element: "#pagefind-search",
      showSubResults: true,
      showImages: false,
    });
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", initPagefind);
  // Re-initialize on Astro page transitions
  document.addEventListener("astro:page-load", initPagefind);

  // Modal open/close logic
  const backdrop = document.getElementById("search-backdrop");
  const closeBtn = document.getElementById("search-close");

  function openSearch() {
    backdrop?.classList.remove("hidden");
    const input = document.querySelector(
      ".pagefind-ui__search-input"
    ) as HTMLInputElement;
    input?.focus();
  }

  function closeSearch() {
    backdrop?.classList.add("hidden");
  }

  // Close button
  closeBtn?.addEventListener("click", closeSearch);

  // Click outside to close
  backdrop?.addEventListener("click", (e) => {
    if (e.target === backdrop) {
      closeSearch();
    }
  });

  // Keyboard shortcuts
  document.addEventListener("keydown", (e) => {
    // Cmd/Ctrl + K to open
    if ((e.metaKey || e.ctrlKey) && e.key === "k") {
      e.preventDefault();
      openSearch();
    }
    // Escape to close
    if (e.key === "Escape") {
      closeSearch();
    }
  });

  // Export for header button
  (window as any).openSearch = openSearch;
</script>
